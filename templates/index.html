<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gutenberg Text Cleaner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    *{ box-sizing:border-box; }
    body { font-family: Arial, sans-serif; margin: 40px; line-height:1.5; }
    h1 { margin: 0 0 8px; }
    p.muted { color: var(--muted); margin-top: 0; }
    form { display:flex; gap:8px; margin:16px 0 8px; flex-wrap:wrap; }
    input[type="url"] { flex:1 1 420px; padding:10px 12px; font-size:16px; border:1px solid var(--border); border-radius:10px; }
    button { padding:10px 14px; font-size:16px; border:1px solid var(--border); background:#111827; color:white; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .loading { display:none; color:#111827; font-weight:600; }
    .error { color:#b00020; font-weight:bold; margin-top:8px; white-space:pre-wrap; }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:16px; }
    pre, code { background:#f6f8fa; padding:12px; border-radius:10px; overflow:auto; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--border); vertical-align:top; }
    th { width:260px; font-weight:600; }
    .small { font-size: 0.92rem; }

    /* Optional: cards layout */
    .grid { display:grid; gap:16px; }
  </style>
</head>
<body>
  <h1>Gutenberg Text Cleaner</h1>
  <p class="muted">Enter a Project Gutenberg <code>.txt</code> URL to clean and analyze the text.</p>

  <form id="clean-form" aria-label="Clean and analyze text form">
    <input id="url-input" type="url" placeholder="https://www.gutenberg.org/files/84/84-0.txt" required />
    <button id="submit-btn" type="submit">Clean & Analyze</button>
    <span id="loading" class="loading" role="status" aria-live="polite">Processing…</span>
  </form>

  <div id="error" class="error" role="alert" aria-live="assertive"></div>

  <div id="results" style="display:none;" class="grid">
    <div class="card">
      <h3>Statistics</h3>
      <table id="stats-table" class="small"></table>
    </div>

    <div class="card">
      <h3>3-Sentence Summary</h3>
      <p id="summary" class="small"></p>
    </div>

    <div class="card">
      <h3>Cleaned Text (first 500 chars)</h3>
      <pre id="preview" class="small"></pre>
    </div>
  </div>

  <script>
    const form = document.getElementById('clean-form');
    const urlInput = document.getElementById('url-input');
    const submitBtn = document.getElementById('submit-btn');
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('error');
    const results = document.getElementById('results');
    const statsTable = document.getElementById('stats-table');
    const previewEl = document.getElementById('preview');
    const summaryEl = document.getElementById('summary');

    function setLoading(on) {
      loading.style.display = on ? 'inline' : 'none';
      submitBtn.disabled = on;
    }
    function showError(msg) {
      errorBox.textContent = msg || '';
      errorBox.style.display = msg ? 'block' : 'none';
    }
    function renderStats(stats) {
      const rows = [
        ['Total characters', stats.total_characters ?? '—'],
        ['Total words', stats.total_words ?? '—'],
        ['Total sentences', stats.total_sentences ?? '—'],
        ['Avg word length', stats.avg_word_length ?? '—'],
        ['Avg sentence length (words)', stats.avg_sentence_length ?? '—'],
        ['Most common words', Array.isArray(stats.most_common_words)
          ? stats.most_common_words.map(([w,c]) => `${w} (${c})`).join(', ')
          : '—'
        ],
      ];
      statsTable.innerHTML = rows.map(([k,v]) => `<tr><th>${k}</th><td>${v}</td></tr>`).join('');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      results.style.display = 'none';
      showError('');
      setLoading(true);
      try {
        const url = urlInput.value.trim();
        if (!url.toLowerCase().endsWith('.txt')) {
          throw new Error('Please provide a direct Project Gutenberg .txt URL.');
        }
        const resp = await fetch('/api/clean', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ url })
        });
        const data = await resp.json();
        if (!resp.ok || !data.success) {
          throw new Error(data.error || 'Failed to process the URL.');
        }

        renderStats(data.statistics || {});
        const cleaned = data.cleaned_text || '';
        previewEl.textContent = cleaned.slice(0, 500) + (cleaned.length > 500 ? '...' : '');
        summaryEl.textContent = data.summary || '';

        results.style.display = 'block';
      } catch (err) {
        showError(err.message);
      } finally {
        setLoading(false);
      }
    });

    // health check on load
    window.addEventListener('load', async () => {
      try {
        const r = await fetch('/health');
        if (!r.ok) throw new Error(String(r.status));
        const j = await r.json();
        console.log('✅ Server:', j.message);
      } catch (e) {
        console.warn('⚠️ Health check failed:', e.message);
      }
    });
  </script>
</body>
</html>
